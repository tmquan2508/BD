tasks.register('setInfectionMarkerComment') {
    description = 'Sets a simple infection marker in the standard ZIP comment field.'
    mustRunAfter tasks.named('shadowJar')

    doLast {
        def originalJar = tasks.shadowJar.archiveFile.get().asFile
        if (!originalJar.exists()) {
            println "Shadow JAR not found. Skipping marker comment."
            return
        }

        println "-> Setting infection marker in ZIP comment for ${originalJar.name}"

        def markerComment = 'openbd.injected'

        def tempJar = file("$buildDir/tmp/commented-${originalJar.name}")
        tempJar.parentFile.mkdirs()

        ant.zip(destfile: tempJar, comment: markerComment) {
            zipfileset(src: originalJar)
        }

        originalJar.delete()
        tempJar.renameTo(originalJar)

        println "-> Infection marker successfully set in ZIP comment."
    }
}